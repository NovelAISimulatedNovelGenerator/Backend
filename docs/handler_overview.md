# Handler层文档

## 概述

Handler层是NovelAI项目基于Hertz框架的请求处理层，负责接收HTTP请求、参数验证、调用服务层处理业务逻辑，并返回响应结果。Handler层是连接客户端和业务逻辑的关键桥梁，实现了基于Proto文件定义的接口。

## 目录结构

```
/biz/handler/
├── background/             # 背景服务处理器
│   └── background_service.go  # 背景服务处理器实现
├── save/                   # 保存服务处理器
│   └── save_handler.go     # 保存服务处理器实现
├── user/                   # 用户服务处理器
│   └── user_handler.go     # 用户服务处理器实现
└── ping.go                 # 健康检查处理器
```

## 通用设计模式

所有Handler采用以下统一的设计模式：

1. **参数校验与绑定**: 使用Hertz框架的`BindAndValidate`方法进行参数绑定和校验
2. **错误处理**: 统一的错误响应格式，包含code和message字段
3. **日志记录**: 使用Hertz的hlog包记录关键操作和错误
4. **JWT认证**: 通过中间件实现统一的JWT认证逻辑
5. **业务逻辑下沉**: 将复杂业务逻辑下沉到Service层，Handler层只负责请求接收和响应返回
6. **状态码规范**: 遵循HTTP状态码标准，同时在响应体中添加自定义业务状态码

## 核心功能模块

### Ping处理器 (ping.go)

简单的健康检查接口，用于验证服务是否正常运行。

```go
// Ping 健康检查接口
func Ping(ctx context.Context, c *app.RequestContext) {
    c.JSON(consts.StatusOK, utils.H{
        "message": "pong",
    })
}
```

### 用户服务处理器 (user_handler.go)

实现了用户相关的HTTP接口处理，包括：

1. **Register**: 用户注册
   - 校验用户名和密码
   - 调用服务层创建用户
   - 返回用户ID和JWT令牌

2. **GetUser**: 获取用户信息
   - 从JWT中提取用户ID
   - 调用服务层获取用户详情
   - 返回用户信息

3. **UpdateUser**: 更新用户信息
   - 校验更新参数
   - 从JWT中提取用户ID
   - 调用服务层更新用户信息

4. **ChangePassword**: 修改用户密码
   - 校验旧密码和新密码
   - 调用服务层修改密码

5. **DeleteUser**: 删除用户（软删除）
   - 从JWT中提取用户ID
   - 调用服务层执行软删除

### 保存服务处理器 (save_handler.go)

实现了用户保存内容相关的HTTP接口处理，包括：

1. **CreateSave**: 创建保存项
   - 校验保存项参数
   - 从JWT中提取用户ID
   - 调用服务层创建保存项
   - 返回保存项ID

2. **GetSave**: 获取保存项
   - 校验保存项ID
   - 从JWT中提取用户ID
   - 调用服务层获取保存项详情
   - 返回保存项信息

3. **UpdateSave**: 更新保存项
   - 校验更新参数
   - 从JWT中提取用户ID
   - 调用服务层更新保存项

4. **DeleteSave**: 删除保存项
   - 校验保存项ID
   - 从JWT中提取用户ID
   - 调用服务层删除保存项

5. **ListSaves**: 列出用户保存项
   - 校验分页参数
   - 从JWT中提取用户ID
   - 调用服务层获取保存项列表
   - 返回保存项列表和总数

### 背景服务处理器 (background_service.go)

背景服务的HTTP接口处理器，目前为基础框架代码，等待实现具体功能。该模块将实现background.proto中定义的世界观、规则和背景信息相关接口。

## 错误处理机制

Handler层采用统一的错误处理机制，主要处理以下几类错误：

1. **参数错误** (400): 参数缺失、格式错误或验证失败
2. **认证错误** (401): 未登录、token失效或解析失败
3. **授权错误** (403): 权限不足
4. **资源错误** (404): 请求的资源不存在
5. **服务器错误** (500): 内部处理逻辑或数据库操作错误

每种错误都有标准化的响应格式：

```json
{
  "code": <错误码>,
  "message": "<错误描述>"
}
```

## JWT认证流程

1. 用户登录/注册成功后，由JWT中间件生成token
2. 前端存储token并在后续请求的Header中携带
3. JWT中间件验证token有效性，并将用户ID存入请求上下文
4. Handler从上下文中获取用户ID，用于后续业务处理

## 最佳实践

1. **参数校验**: 所有请求参数必须进行合法性校验
2. **错误处理**: 详细区分不同类型的错误，返回明确的错误信息
3. **日志记录**: 关键操作点记录日志，便于问题排查
4. **资源访问控制**: 确保用户只能访问自己的数据
5. **业务逻辑分离**: 复杂业务逻辑下沉到Service层
6. **状态管理**: 明确区分HTTP状态码和业务状态码

## 待优化项

1. 完善背景服务的Handler实现
2. 添加请求限流和防刷机制
3. 实现更精细的权限控制
4. 添加请求参数验证的详细规则
5. 优化错误处理和日志记录
