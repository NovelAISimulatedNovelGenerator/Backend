# Service层文档

## 概述

Service层是NovelAI项目的核心业务逻辑层，位于Handler层和数据访问层之间，负责封装和实现所有业务规则和流程处理。该层采用函数式编程风格，确保代码简洁、模块化、低耦合且易于维护，并遵循Hertz框架的设计模式。

## 目录结构

```
/biz/service/
├── background/             # 背景服务业务逻辑
│   └── generate.go         # 小说背景生成逻辑
├── save/                   # 保存服务业务逻辑  
│   └── save_service.go     # 保存相关业务逻辑
└── user/                   # 用户服务业务逻辑
    └── user_service.go     # 用户相关业务逻辑
```

## 设计模式与原则

Service层遵循以下设计模式和原则：

1. **函数式编程风格**: 优先使用纯函数，减少副作用，便于测试和维护
2. **依赖注入**: 通过参数传递依赖，降低模块间耦合度
3. **显式错误处理**: 详细区分不同类型的错误，并向上层传递
4. **单一职责原则**: 每个函数只负责一项特定的业务逻辑
5. **参数验证**: 在业务逻辑开始前进行全面的参数验证
6. **业务逻辑封装**: 所有业务规则都封装在Service层，而不是暴露在Handler层
7. **统一的请求/响应模型**: 使用专门的Service请求和响应结构体，与API层解耦

## 核心服务模块

### 用户服务 (UserService)

用户服务负责处理所有与用户账户管理相关的业务逻辑，包括：

1. **注册用户**: 验证用户名唯一性，加密密码，创建用户记录
2. **用户登录**: 验证用户凭据，生成认证令牌
3. **获取用户信息**: 查询并格式化用户详细信息
4. **更新用户资料**: 修改用户的昵称、头像、邮箱等信息
5. **修改密码**: 验证旧密码，更新为新密码
6. **软删除用户**: 将用户标记为已删除状态

代码示例：
```go
// UserService 用户服务结构体
type UserService struct {
    ctx context.Context
    c   *app.RequestContext
}

// Register 处理用户注册业务逻辑
func (s *UserService) Register(req *user.RegisterRequest) (userId int64, err error) {
    // 检查用户名是否已存在
    // 密码加密
    // 创建用户记录
    // 返回用户ID
}
```

### 保存服务 (Save Service)

保存服务负责管理用户创作内容的存储和检索，包括：

1. **创建保存项**: 生成唯一标识符，存储用户创作内容
2. **获取保存项**: 根据ID检索特定保存项
3. **更新保存项**: 修改已存在保存项的内容和元数据
4. **删除保存项**: 软删除用户的保存项
5. **列出保存项**: 分页获取用户的所有保存项

代码示例：
```go
// Create 创建保存业务逻辑
func Create(ctx context.Context, req *CreateSaveServiceRequest) (*CreateSaveServiceResponse, error) {
    // 参数校验
    // 生成唯一ID
    // 构造保存对象
    // 调用数据访问层创建记录
    // 返回保存ID
}
```

### 背景生成服务 (Background Service)

背景服务采用函数选项模式，负责生成小说世界观、规则和背景信息，包括：

1. **世界观生成**: 创建小说的基础世界设定
2. **规则生成**: 根据世界观创建相应的规则集
3. **背景信息生成**: 根据世界观和规则创建详细的背景信息
4. **自定义生成流程**: 通过选项函数自定义各个生成步骤

代码示例：
```go
// NovelOption 小说生成选项函数类型
type NovelOption func(*NovelOptions) error

// 生成小说及其相关背景设定
func generate(ctx context.Context, options ...NovelOption) (*NovelInfo, error) {
    // 初始化默认选项
    // 应用自定义选项
    // 生成世界观
    // 生成规则
    // 生成背景
    // 应用后处理
}
```

## 数据流转与交互

1. **请求流转**: 
   Handler层 → Service层请求结构体 → 业务处理 → Service层响应结构体 → Handler层

2. **数据访问**: 
   Service层 → 数据访问层(DB) → 数据模型转换 → Service层

3. **错误处理**: 
   数据访问层错误 → Service层错误转换与补充 → Handler层错误响应

## 错误处理机制

Service层定义了一系列业务错误，并在适当的地方进行捕获和转换：

1. **参数验证错误**: 请求参数不合法或缺失时返回
2. **资源不存在错误**: 查询的资源不存在时返回
3. **权限错误**: 用户无权访问请求的资源时返回
4. **业务逻辑错误**: 违反业务规则时返回
5. **数据库错误**: 数据库操作失败时返回，通常会转换为友好的业务错误

## 安全性考虑

1. **密码处理**: 所有密码在Service层使用加密函数处理，不会以明文形式存储
2. **数据隔离**: 严格校验用户只能访问自己的数据
3. **数据验证**: 对所有输入数据进行严格验证，防止注入和其他安全问题

## 扩展与优化

1. **缓存集成**: 可在Service层添加缓存机制，提高频繁访问数据的响应速度
2. **异步处理**: 对于耗时操作，可引入消息队列或异步处理机制
3. **监控与统计**: 添加性能监控和业务统计功能
4. **分布式锁**: 对于需要避免并发问题的业务操作，引入分布式锁机制

## 测试策略

Service层的测试应当关注业务逻辑正确性，主要包括：

1. **单元测试**: 测试各个业务函数的逻辑和边界条件
2. **模拟测试**: 使用模拟数据库测试业务流程
3. **集成测试**: 测试Service层与数据访问层的交互
